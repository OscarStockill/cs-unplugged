sudo: required
services:
- docker
language: python
python:
- '3.6'
before_install:
- sudo rm -f /etc/boto.cfg
install:
- wget https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip
  -O browserStackLocal.zip
- unzip browserStackLocal.zip
- "./BrowserStackLocal --key $KEY --force-local &"
- sudo docker --version
- sudo docker-compose --version
jobs:
  include:
  - stage: test
    name: Load content
    script: "./csu ci load_content"
  - script: "./csu ci test_general"
    name: Run general tests
  - script: "./csu ci test_resources"
    name: Run resource tests
  - script: "./csu ci test_management"
    name: Run management tests
  - script: "./csu ci test_backwards"
    name: Run test suite backwards
    if: type = pull_request
  - script: "./csu ci test_in_browser"
    name: Run in-browser tests
  - script: "./csu ci style"
    name: Run style checker
  - script: "./csu ci docs"
    name: Build documentation
  - stage: develop deploy
    name: Deploy app to Google App Engine
    script: skip
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-app.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy static files to Google Storage Bucket
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-static-files.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Update Google Cloud Platform database
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/update-database.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 1
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-1.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 2
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-2.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 3
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-3.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 4
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-4.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 5
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-5.sh
      skip_cleanup: true
      on:
        branch: develop
  - stage: production deploy
    script: skip
    name: Deploy app to Google App Engine
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-app.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy static files to Google Storage Bucket
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-static-files.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Update Google Cloud Platform database
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/update-database.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 1
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-1.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 2
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-2.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 3
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-3.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 4
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-4.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 5
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-5.sh
      skip_cleanup: true
      on:
        branch: master
notifications:
  email: false
  slack:
    rooms: deptfunstuff:abJKvzApk5SKtcEyAgtswXAv
    on_success: change
    on_failure: change
stages:
- name: test
- name: develop deploy
  if: branch = develop
- name: production deploy
  if: branch = master
env:
  global:
  - secure: CJ4i1yV/1pbLJ0kmL2hSEYWAMY1swJGiCIRdpB2yyvRTxwr/P8QWdXGXFFazDk/Ybfbk1Gr85kcZAd5R825NzTtdlTg77wHrsm9mSKisP9cFE8UtXXg+DxpkEWUGpM2Fr94ACmWYlaxxtB7nJyHQRkvTpCQajxeqzRaLwNwbqwM/ZTPC3Xgb+yjIfzKQJLmsyj/jxxkLtBWJIexi8xAJEmi1vnTbS4PJzUP3rCd9TdEMXWnuMHhwkljOCLjmJAJpBZmQOB+vdCHEFi8bQdKFTPXi3y+QTm5Rzicl/h/4p3/JTDk7ODnSxpSp2U0PFVPX+DIwRC6Aq/pwPvAJks8xvbP8rJEbm52Hou+/zHPXik+Pas9cH74pdAs3g9o3WL4mQvp1Fu6ulScMCJfVTsp+p3SrCS4AgEZgdck+OyKkcjZnluaKL1SLtt3eeeSvvpYmOh3l8F+w5F44VmlmByK5ZlRj8OM/uL0ZZAWeFO+X+I+TxeFrgTlmvyq9iDLMiNsyiViguy6sCNSFJeQoIfFL0NxFnvDO0IINMtceMMWvM5rgB/Qee75GKY7fzwwdI/PavSR1TOH7YQUqEZ3EPBB+fEiQaZ0E9nt2VAOKR+22PDdL0XSx5PnY7ZC2TGK6AFNdGDE1L6YoDjxFo8XKFxB4DqBkIIRu8en5kvUOB0tzKms=
