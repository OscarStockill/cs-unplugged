sudo: required
services:
- docker
language: python
python:
- '3.6'
addons:
  browserstack:
    username: csse-education-research@canterbury.ac.nz
    access_key:
      secure: BROWSERSTACK_ACCESS_KEY
before_install:
- sudo rm -f /etc/boto.cfg
install:
- pip install nose
- wget https://www.browserstack.com/browserstack-local/BrowserStackLocal-linux-x64.zip
  -O browserStackLocal.zip
- unzip browserStackLocal.zip
- ./BrowserStackLocal --key y1shw2Ck8GyVc53Y4LrT --force-local &
- sudo docker --version
- sudo docker-compose --version
jobs:
  include:
  - stage: test
    name: Load content
    script: "./csu ci load_content"
  - script: "./csu ci test_general"
    name: Run general tests
  - script: "./csu ci test_resources"
    name: Run resource tests
  - script: "./csu ci test_management"
    name: Run management tests
  - script: "./csu ci test_backwards"
    name: Run test suite backwards
    if: type = pull_request
  - script: "./csu ci test_in_browser"
    name: Run in-browser tests
  - script: "./csu ci style"
    name: Run style checker
  - script: "./csu ci docs"
    name: Build documentation
  - stage: develop deploy
    name: Deploy app to Google App Engine
    script: skip
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-app.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy static files to Google Storage Bucket
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-static-files.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Update Google Cloud Platform database
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/update-database.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 1
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-1.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 2
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-2.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 3
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-3.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 4
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-4.sh
      skip_cleanup: true
      on:
        branch: develop
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 5
    deploy:
    - provider: script
      script: bash ./infrastructure/dev-deploy/deploy-resources-5.sh
      skip_cleanup: true
      on:
        branch: develop
  - stage: production deploy
    script: skip
    name: Deploy app to Google App Engine
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-app.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy static files to Google Storage Bucket
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-static-files.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Update Google Cloud Platform database
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/update-database.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 1
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-1.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 2
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-2.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 3
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-3.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 4
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-4.sh
      skip_cleanup: true
      on:
        branch: master
  - script: skip
    name: Copy resource PDFs to Google Storage Bucket - Part 5
    deploy:
    - provider: script
      script: bash ./infrastructure/prod-deploy/deploy-resources-5.sh
      skip_cleanup: true
      on:
        branch: master
notifications:
  email: false
  slack:
    rooms: deptfunstuff:abJKvzApk5SKtcEyAgtswXAv
    on_success: change
    on_failure: change
stages:
- name: test
- name: develop deploy
  if: branch = develop
- name: production deploy
  if: branch = master
env:
  global:
  - secure: YmST3U8m7PErpcqG9kcKfK82rII37qhH5+U3fZgVhrQuS72gStDqSa7KrrtlKj8mdyhfNQMeAicb6Sp4zqnG2WR9LdPIs/aOr89OVaIkXTAiMAeGrYcHVC/A5/B/TkymGzyQ49Ox0Saqde2nlChQgPMw6EfICBYcRHHI5GF1A+vJbmUsz/NkTEbka4JjOQ9L4klggTfaYrcLaQXuR+gn2c6AYSPwHrxeekj+dgSVuopJ5a+tcod3S/kaAf3BYE6ibgiNHv10wNb2xbjXfmzyHl6+WP4ocZauHljc94K7i1+O+fj4jTe6xbN7/LkMz1ibRFAzIvQtsuf/Lfr5QpWCMZwZrgmfYYFLU2vRJ2sBed7KwG1bmlqVGnIeiKGH/CoFZ1rbxJa8fbC3WZxLoy3MQc7nmMtSN0ngGxMa64kCfBXTV35aKycAB9weWaGfbjZ4z0Dt4/o2bVL/SLp5/7V2IV1BvxUt6pUND7ZR3h5DyLL0HU63YeKYUe6RxR7kVAgukEu6ORRiLWxdSeQ/ZAUf2LncMjG10MoC88BVK6DYKYGjXdgCD0v3+6Rxr1kVoFXgS/NoS1IsFAO/UTpnV82vIETxj3BBt2RdRNH09SmpXf87Pai6Warr4kJcAyVvl3too30a4rQIlXTHQz/JiW+z8lJ1EDrpnV5kOhQQ2Fkptkg=
  - secure: DAs1gY2aiDXk4WASkVM3D9AlkPhJoBVkTU4Kugc5lBcmL0jGwYeJb0lrRbeBN8kI0Hi7W/5/e4KhGsLX5I+wHcynS/1aEO0HlETj+oeTiXbO50CFe2Po+VMvww5/uXzHh9gvR6eVqFwgo8NOywAlY2bE1IqFLOJ11Cw67JshiKSlQK3aBuBnWlVwbdREb7b7oWbItoYp2GoKgp4B8Gj89DJ/xJ46j7Yy4bLmz4NiguNZurC+iX6Vlt6VqccaqvLQllMbdRFTt6zLn0Nw1gQ/sa3+yMQLH10cKHAd/BlAF2Tp0NTQjQf/svVWzOPXB9NpPdsJCD55SSPW0ROJOkO05qL1IPbTp+cpZLBU6vU5CoTKEgjwGLNa2HFA8Yac0EEECNUL+fibCDCT4ZWEQoYsIluYy/f7mx0TZoy0dlaS1qUyjiRewxhFkhnnWt98ChA+YAzkZ/7IsBDCFDAUVC3l57yP4ddfbOYBtOQP+YSbTLIwYbJXHz+3/YozTD/GXUyA+aikziRt4d7nCaJ7UxvG+TnGY//sTvsdFlZ34vSNs91Qe6c2DUMhxDVyaycnR9/ptnnD08A9QO1r9I1uDT8hSho+ILHrAyoBpYweRO2bjaCxwCfbkLWn471xvQN3MK3oib527Ns0h4bHrWe717SIqhMoPXvZheE/vi/0Xyn8iEU=
  - secure: OKk2qRDz1LSs80BtlBYSoi94GT11mxNm7aorSS9vHvHM01gsT5LbTTOFEJyEQV/gKkY11U22o3WYYXB+NjFl2fF9VyzP6c5AX/oU1W9yyqtyMrt+f0BfAYEfKGq8ITzAk7aT/JK+vpA9MHlWpUB5totZXFFMpY9wxziRPTU8peJitEamALA1Sg5KH+gpIih5qwFt4VpZt2xbVo5+s6f4vQkBLdYBtaViW9XQTlYwRSQVs/Ri1eQrg7raygP2TgFyhHPR39qG9GibV9wwa59DCHxX0R8ELkGU2d48I/HVCC9UFHZol3p2eHg+qfyPFM+gdkphMaj8RZLD/m+lm9J3C3tZo9uRiBVEv52m7qSrhN1ytzbR3R24aG20IugyVhauGjowl1tylIbn7bwFbjtGzpdPke0kPdV7UCB6VTmwiW2mOEemKpbPFVCkhAAZ/EcetiA/FbEkK1ZTaB2uLTuD8JY0+MEwDISSxVPvKo005ou3YfUaCniLFL29ccImvDokYiNsTRmFURD8PojeVJ9u3fo8fgSu0Z2pdF22HXwz1IBFkXqc1mH7aMsG+aYtaYCQp9pzzhxG91+JquikthOpoBJqy9DrvIxyajsYO0FJPbxbTSLV+d4sQ3JgMmch9l1RAhRdp/jQfC7MTtoqj35B0WjiFTxGenl69a4O7FUiEc8=
